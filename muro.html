<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Muro Global - LCDM</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00ffff">
<style>
body{font-family:sans-serif;background:#111;color:#fff;padding:12px}
#top{display:flex;align-items:center;gap:8px}
#feed{max-width:900px;margin:20px auto;display:flex;flex-direction:column;gap:12px}
.post{background:#222;padding:12px;border-radius:10px}
textarea{width:100%;min-height:80px;padding:8px;border-radius:8px;border:none}
.btn{background:gold;color:black;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
.preview img{max-width:160px;border-radius:8px;display:block;margin-top:8px}
</style>
</head>
<body>
<div id="top">
  <div id="usuarioInfo"></div>
  <div style="margin-left:auto">
    <button class="btn" onclick="location.href='album.html'">Volver al Álbum</button>
    <button class="btn" onclick="location.href='ranking.html'">Ranking</button>
    <button class="btn" id="btnLogout">Logout</button>
  </div>
</div>

<div id="newPost" style="max-width:900px;margin:14px auto;background:#111;padding:12px;border-radius:8px">
  <textarea id="postTexto" placeholder="Escribe tu post..."></textarea>
  <input type="file" id="postImagen" accept="image/*">
  <div class="preview" id="preview"></div>
  <div style="text-align:right;margin-top:8px">
    <button class="btn" id="btnPublicar">Publicar</button>
  </div>
</div>

<div id="feed"></div>

<script src="frontend-api.js"></script>
<script>
function getSessionUsuario(){ const s = sessionStorage.getItem('lcdm_usuario'); if(!s) return null; try{return JSON.parse(s);}catch(e){return null;} }
const usuario = getSessionUsuario();
if(!usuario){ location.href='index.html'; }
document.getElementById('usuarioInfo').innerHTML = `<img src="${usuario.avatar}" style="width:40px;height:40px;border-radius:50%;vertical-align:middle;margin-right:8px"> <strong>${usuario.usuario}</strong>`;
document.getElementById('btnLogout').addEventListener('click', ()=>{ sessionStorage.removeItem('lcdm_usuario'); location.href='index.html'; });

const postImagenInput = document.getElementById('postImagen');
const preview = document.getElementById('preview');
postImagenInput.addEventListener('change', ()=>{
  const file = postImagenInput.files[0];
  if(!file) { preview.innerHTML=''; return; }
  const reader = new FileReader();
  reader.onload = ()=> preview.innerHTML = `<img src="${reader.result}">`;
  reader.readAsDataURL(file);
});

async function fetchPosts(){
  const res = await getJSON('get_posts.php');
  const feed = document.getElementById('feed'); feed.innerHTML='';
  if(res.success && res.posts){
    res.posts.forEach(p => {
      const div = document.createElement('div'); div.className='post';
      div.innerHTML = `
        <div style="display:flex;gap:10px;align-items:center">
          <img src="${p.avatar}" style="width:48px;height:48px;border-radius:50%">
          <strong>${p.usuario}</strong> <small style="color:#aaa;margin-left:8px">${p.created_at}</small>
        </div>
        <p style="margin-top:8px">${p.texto || ''}</p>
        ${p.figurita?`<img src="https://i.ibb.co/781Qj0J/${p.figurita}.png" style="max-width:200px;border-radius:8px">`:''}
        ${p.imagen?`<img src="${p.imagen}" style="max-width:400px;border-radius:8px;margin-top:8px">`:''}
        <div style="margin-top:8px">
          <button class="btn" onclick="darLike(${p.id})">❤️ <span id="like-${p.id}">${p.likes||0}</span></button>
        </div>
      `;
      feed.appendChild(div);
    });
  } else {
    feed.innerHTML = '<p>No hay posts</p>';
  }
}

async function publicarPost(){
  const texto = document.getElementById('postTexto').value.trim();
  let imagen = '';
  if(postImagenInput.files[0]){
    imagen = await new Promise((resolve)=>{
      const r = new FileReader();
      r.onload = ()=> resolve(r.result);
      r.readAsDataURL(postImagenInput.files[0]);
    });
  }
  const body = { usuario: usuario.usuario, texto, imagen };
  const res = await postJSON('create_post.php', body);
  if(res.success){ document.getElementById('postTexto').value=''; postImagenInput.value=''; preview.innerHTML=''; fetchPosts(); alert('Publicado!'); }
  else alert(res.message || 'Error al publicar');
}

async function darLike(post_id){
  const res = await postJSON('like_post.php', { usuario: usuario.usuario, post_id });
  if(res.success){ const span = document.getElementById('like-'+post_id); if(span) span.textContent = parseInt(span.textContent||'0')+1; }
  else alert(res.message || 'Error like');
}

document.getElementById('btnPublicar').addEventListener('click', publicarPost);

fetchPosts();
setInterval(fetchPosts, 3500); // refrezca cada 3.5s
</script>
</body>
</html>
